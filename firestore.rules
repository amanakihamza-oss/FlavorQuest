rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      // Replace with your actual admin email or UID logic
      // For now, checking if email matches the project domain or specific admin
      return request.auth.token.email.matches('.*@flavorquest.be') || 
             request.auth.token.email.matches('.*@flavorquest.com') ||
             request.auth.token.email == 'admin@flavorquest.com'; 
    }

    // --- Places ---
    match /places/{placeId} {
      // Public read
      allow read: if true;
      
      // Auth users can propose a place (must be pending)
      allow create: if isAuthenticated() 
                    && request.resource.data.validationStatus == 'pending'
                    && request.resource.data.keys().hasAll(['name', 'city', 'category']);
      
      // Only Admins can update (approve) or delete
      // FALLBACK: For now, allowing any auth user to update/delete to prevent breaking your current workflow
      // if you share a generic login. Ideally, switch to 'if isAdmin()'.
      allow update, delete: if isAuthenticated(); 
    }

    // --- Reviews ---
    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if isAuthenticated();
      // Users can delete their own reviews, Admins can delete any
      allow delete: if isAuthenticated() && (request.auth.uid == resource.data.userId || isAdmin());
    }

    // --- Articles (Blog) ---
    match /articles/{articleId} {
      allow read: if true;
      allow write: if isAuthenticated(); // Restrict to logged users (Partners/Admins)
    }

    // --- Users ---
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // --- Claim Requests ---
    match /claim_requests/{claimId} {
      allow create: if isAuthenticated();
      allow read, write: if isAdmin(); // Only admins process claims
    }
  }
}
